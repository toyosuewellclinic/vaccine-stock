<!-- ============================================================
  è±Šæ´²ã‚¤ãƒ¼ã‚¦ã‚§ãƒ«ã‚¯ãƒªãƒ‹ãƒƒã‚¯ ãƒ¯ã‚¯ãƒãƒ³åœ¨åº« è‡ªå‹•è¡¨ç¤ºã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ
  WordPressã®è¨˜äº‹ç·¨é›†ç”»é¢ã§ã€Œã‚«ã‚¹ã‚¿ãƒ HTMLã€ãƒ–ãƒ­ãƒƒã‚¯ã«è²¼ã‚Šä»˜ã‘ã‚‹
  ============================================================ -->

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
  #vaccine-stock-widget {
    font-family: sans-serif;
    margin: 20px 0;
  }
  #vaccine-stock-widget h3.vs-section-title {
    font-size: 16px;
    font-weight: bold;
    margin: 24px 0 8px;
    padding: 6px 12px;
    border-left: 4px solid #0066cc;
    background: #f0f4f8;
    color: #1a2332;
  }
  #vaccine-stock-widget h3.vs-section-title:first-child {
    margin-top: 0;
  }
  #vaccine-stock-widget .vs-updated {
    font-size: 12px;
    color: #888;
    margin-bottom: 16px;
    text-align: right;
  }
  #vaccine-stock-widget .vs-sync-dot {
    display: inline-block;
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background: #27ae60;
    margin-right: 4px;
    vertical-align: middle;
  }
  #vaccine-stock-widget table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    margin-bottom: 8px;
  }
  #vaccine-stock-widget th {
    background: #f0f4f8;
    padding: 9px 14px;
    text-align: left;
    font-weight: bold;
    border: 1px solid #dde4ec;
    color: #333;
  }
  #vaccine-stock-widget td {
    padding: 9px 14px;
    border: 1px solid #dde4ec;
    vertical-align: middle;
  }
  #vaccine-stock-widget tr:nth-child(even) td {
    background: #f8fafc;
  }
  #vaccine-stock-widget .vs-qty-cell {
    text-align: center;
    font-weight: bold;
    font-size: 15px;
    min-width: 80px;
    white-space: nowrap;
  }
  #vaccine-stock-widget .vs-qty-cell.out  { color: #c0392b; }
  #vaccine-stock-widget .vs-qty-cell.low  { color: #e67e22; }
  #vaccine-stock-widget .vs-qty-cell.ok   { color: #27ae60; }
  #vaccine-stock-widget .vs-badge {
    display: inline-block;
    font-size: 11px;
    padding: 2px 7px;
    border-radius: 20px;
    font-weight: bold;
    margin-left: 6px;
    vertical-align: middle;
  }
  #vaccine-stock-widget .vs-badge.out { background: #fdecea; color: #c0392b; }
  #vaccine-stock-widget .vs-badge.low { background: #fef9e7; color: #e67e22; }
  #vaccine-stock-widget .vs-loading {
    text-align: center; padding: 30px; color: #888; font-size: 14px;
  }
</style>

<div id="vaccine-stock-widget">
  <div class="vs-loading">â³ åœ¨åº«æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
</div>

<script>
(function() {
  const firebaseConfig = {
    apiKey: "AIzaSyAbUBYMYfKoQmBuPZVfCjjtBfZ0SoWTgMU",
    authDomain: "clinic-inventory-c2207.firebaseapp.com",
    projectId: "clinic-inventory-c2207",
    storageBucket: "clinic-inventory-c2207.firebasestorage.app",
    messagingSenderId: "609898487561",
    appId: "1:609898487561:web:6388126fef0c9672803dd8"
  };

  let app;
  try { app = firebase.app('vaccine-widget'); }
  catch(e) { app = firebase.initializeApp(firebaseConfig, 'vaccine-widget'); }
  const db = firebase.firestore(app);

  // ===== å›½ç”£ãƒ¯ã‚¯ãƒãƒ³ï¼ˆFirestoreã®å•†å“åã¨å®Œå…¨ä¸€è‡´ã•ã›ã‚‹ã“ã¨ï¼‰ =====
  const DOMESTIC = [
    { name: 'ãŠãŸãµããƒ¯ã‚¯ãƒãƒ³',                     price: '6,600å††(ç¨è¾¼)' },
    { name: 'å›½ç”£Aå‹è‚ç‚ãƒ¯ã‚¯ãƒãƒ³(ã‚¨ã‚¤ãƒ ã‚²ãƒ³)',       price: '8,800å††(ç¨è¾¼)' },
    { name: 'ç ´å‚·é¢¨ãƒˆã‚­ã‚½ã‚¤ãƒ‰',                     price: '3,800å††(ç¨è¾¼)' },
    { name: '3ç¨®æ··åˆ(DPT)ãƒ¯ã‚¯ãƒãƒ³(ãƒˆãƒªãƒ“ãƒƒã‚¯)',      price: '5,500å††(ç¨è¾¼)' },
    { name: 'å¸¯çŠ¶ç–±ç–¹ãƒ¯ã‚¯ãƒãƒ³(ã‚·ãƒ³ã‚°ãƒªãƒƒã‚¯ã‚¹)',       price: '22,000å††(ç¨è¾¼)' },
    { name: 'è‚ºç‚çƒèŒãƒ¯ã‚¯ãƒãƒ³(ãƒ‹ãƒ¥ãƒ¼ãƒ¢ãƒãƒƒã‚¯ã‚¹)',     price: '8,500å††(ç¨è¾¼)' },
    { name: 'æ°´ç—˜ãƒ»å¸¯çŠ¶ç–±ç–¹ãƒ¯ã‚¯ãƒãƒ³ï¼ˆç”Ÿãƒ¯ã‚¯ãƒãƒ³ï¼‰',  price: '8,400å††(ç¨è¾¼)' },
    { name: 'MRãƒ¯ã‚¯ãƒãƒ³(ãƒŸãƒ¼ãƒ«ãƒ“ãƒƒã‚¯)',              price: '8,800å††(ç¨è¾¼)' },
    { name: 'å›½ç”£Bå‹è‚ç‚ãƒ¯ã‚¯ãƒãƒ³(ãƒ“ãƒ¼ãƒ ã‚²ãƒ³)',       price: '3,500å††(ç¨è¾¼)' },
  ];

  // ===== è¼¸å…¥ãƒ¯ã‚¯ãƒãƒ³ï¼ˆFirestoreã®å•†å“åã¨å®Œå…¨ä¸€è‡´ã•ã›ã‚‹ã“ã¨ï¼‰ =====
  const IMPORTED = [
    { name: 'è¼¸å…¥è…¸ãƒãƒ•ã‚¹ãƒ¯ã‚¯ãƒãƒ³(Typbar TCV)',      price: '11,000å††(ç¨è¾¼)' },
    { name: 'è¼¸å…¥ç‹‚çŠ¬ç—…ãƒ¯ã‚¯ãƒãƒ³(ChiroRab)',          price: '14,800å††(ç¨è¾¼)' },
    { name: 'è¼¸å…¥Aå‹è‚ç‚ãƒ¯ã‚¯ãƒãƒ³(Havrix)',           price: '8,800å††(ç¨è¾¼)' },
    { name: 'è¼¸å…¥ã‚³ãƒ¬ãƒ©ãƒ¯ã‚¯ãƒãƒ³(DUKORAL)',           price: '(12,000å††ç¨è¾¼)' },
    { name: 'è¼¸å…¥3ç¨®æ··åˆãƒ¯ã‚¯ãƒãƒ³ï¼ˆBoostrixï¼‰',       price: '5,500å††(ç¨è¾¼)' },
    { name: 'è¼¸å…¥æ—¥æœ¬è„³ç‚ãƒ¯ã‚¯ãƒãƒ³(JENVAC)',          price: '6,600å††(ç¨è¾¼)' },
    { name: 'è¼¸å…¥Aå‹Bå‹è‚ç‚ãƒ¯ã‚¯ãƒãƒ³(Twinrix)',       price: '17.600å††(ç¨è¾¼)' },
  ];

  function buildTable(config, stockMap) {
    let rows = '';
    config.forEach(function(cfg) {
      const p = stockMap[cfg.name];
      let qtyHtml, badgeHtml = '', cls = '';

      if (!p) {
        qtyHtml = '<span style="color:#bbb">ï¼</span>';
      } else if (p.stock === 0) {
        cls = 'out';
        qtyHtml = 'çµ‚äº†';
        badgeHtml = '<span class="vs-badge out">åœ¨åº«åˆ‡ã‚Œ</span>';
      } else if (p.stock < p.minStock) {
        cls = 'low';
        qtyHtml = p.stock + '&nbsp;' + (p.unit || 'å€‹');
        badgeHtml = '<span class="vs-badge low">æ®‹ã‚Šã‚ãšã‹</span>';
      } else {
        cls = 'ok';
        qtyHtml = p.stock + '&nbsp;' + (p.unit || 'å€‹');
      }

      rows += '<tr>'
        + '<td>' + cfg.name + badgeHtml + '</td>'
        + '<td class="vs-qty-cell ' + cls + '">' + qtyHtml + '</td>'
        + '<td>' + cfg.price + '</td>'
        + '</tr>';
    });

    return '<table>'
      + '<thead><tr><th>ç¨®é¡</th><th style="text-align:center">åœ¨åº«</th><th>ä¾¡æ ¼</th></tr></thead>'
      + '<tbody>' + rows + '</tbody>'
      + '</table>';
  }

  const widget = document.getElementById('vaccine-stock-widget');

  db.collection('products')
    .where('category', '==', 'ãƒ¯ã‚¯ãƒãƒ³')
    .onSnapshot(function(snap) {
      const stockMap = {};
      snap.forEach(function(doc) {
        const d = doc.data();
        stockMap[d.name] = d;
      });

      const now = new Date();
      const dateStr = now.toLocaleDateString('ja-JP', {
        year: 'numeric', month: 'long', day: 'numeric',
        hour: '2-digit', minute: '2-digit'
      }) + ' æ›´æ–°';

      widget.innerHTML =
        '<div class="vs-updated"><span class="vs-sync-dot"></span>' + dateStr + '</div>'
        + '<h3 class="vs-section-title">ğŸ‡¯ğŸ‡µ å›½ç”£ãƒ¯ã‚¯ãƒãƒ³</h3>'
        + buildTable(DOMESTIC, stockMap)
        + '<h3 class="vs-section-title">âœˆï¸ è¼¸å…¥ãƒ¯ã‚¯ãƒãƒ³</h3>'
        + buildTable(IMPORTED, stockMap);

    }, function(err) {
      widget.innerHTML = '<div class="vs-loading">âš ï¸ ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message + '</div>';
    });
})();
</script>
